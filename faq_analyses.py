# -*- coding: utf-8 -*-
"""База 1400+ частых вопросов по анализам (женские и мужские). Поиск по ключевым словам."""

import re
from typing import List, Tuple

# Вопрос — ответ. Ключевые слова извлекаются из вопроса и ответа для поиска.
FAQ = [
    # Общий анализ крови
    {"q": "Что значит пониженный гемоглобин?", "a": "Пониженный гемоглобин может указывать на анемию, кровопотерю, дефицит железа, витамина B12 или фолиевой кислоты. Интерпретацию проводит врач с учётом других показателей и клиники."},
    {"q": "Повышенный гемоглобин причины", "a": "Повышенный гемоглобин бывает при обезвоживании, курении, проживании в горах, эритремии, хронических заболеваниях лёгких. Нужна консультация врача."},
    {"q": "Норма гемоглобина у женщин", "a": "Норма гемоглобина у женщин обычно 120–150 г/л. При беременности нижняя граница может быть 110 г/л. Референсы зависят от лаборатории."},
    {"q": "Норма гемоглобина у мужчин", "a": "Норма гемоглобина у мужчин обычно 130–170 г/л. Референсные значения указываются на бланке лаборатории."},
    {"q": "Повышенные эритроциты в крови что это", "a": "Повышение эритроцитов возможно при обезвоживании, курении, гипоксии, патологии почек, эритремии. Требуется дообследование."},
    {"q": "Понижены эритроциты причины", "a": "Снижение эритроцитов часто связано с анемией, кровопотерей, дефицитом железа или витаминов, хроническими заболеваниями. Обратитесь к врачу."},
    {"q": "Лейкоциты повышены что это значит", "a": "Повышение лейкоцитов бывает при инфекциях, воспалении, стрессе, после еды, при лейкозах. Интерпретация по лейкоцитарной формуле и клинике."},
    {"q": "Лейкоциты понижены причины", "a": "Низкие лейкоциты возможны при вирусных инфекциях, приёме некоторых препаратов, заболеваниях костного мозга, аутоиммунных процессах. Нужен врач."},
    {"q": "СОЭ повышена что значит", "a": "Повышенная СОЭ указывает на воспаление, инфекцию, анемию, беременность, хронические болезни. Неспецифичный показатель — оценивается вместе с другими анализами."},
    {"q": "Тромбоциты повышены причины", "a": "Повышение тромбоцитов бывает при воспалении, после операций, при железодефиците, опухолях, первичных тромбоцитозах. Интерпретирует врач."},
    {"q": "Тромбоциты понижены что делать", "a": "Низкие тромбоциты требуют выяснения причины: инфекции, лекарства, аутоиммунные заболевания, патология костного мозга. Обратитесь к терапевту или гематологу."},
    {"q": "Гематокрит понижен что это", "a": "Сниженный гематокрит часто сопутствует анемии, кровопотере, гипергидратации. Оценивается вместе с гемоглобином и эритроцитами."},
    {"q": "Гематокрит повышен у мужчин", "a": "Повышение гематокрита у мужчин возможно при обезвоживании, курении, эритремии, хронической гипоксии. Нужна консультация врача."},
    # Биохимия
    {"q": "Глюкоза в крови повышена причины", "a": "Повышенная глюкоза бывает при диабете, стрессе, приёме пищи, панкреатите, эндокринных заболеваниях. Для диагноза важны повторные анализы и HbA1c."},
    {"q": "Глюкоза понижена что это", "a": "Низкая глюкоза возможна при голодании, передозировке инсулина, инсулиноме, надпочечниковой недостаточности. При симптомах гипогликемии — срочно к врачу."},
    {"q": "Норма глюкозы натощак", "a": "Норма глюкозы венозной плазмы натощак обычно до 6,1 ммоль/л. Капиллярной крови — до 5,6 ммоль/л. Референсы уточняйте в лаборатории."},
    {"q": "Холестерин общий повышен что делать", "a": "Повышенный холестерин — фактор риска атеросклероза. Важны ЛПНП, ЛПВП и триглицериды. Рекомендации по питанию и лечению даёт врач."},
    {"q": "ЛПНП повышен причины", "a": "Высокий ЛПНП («плохой» холестерин) связан с питанием, наследственностью, гипотиреозом, заболеваниями печени и почек. Коррекция — по назначению врача."},
    {"q": "ЛПВП понижен что значит", "a": "Низкий ЛПВП («хороший» холестерин) повышает риск сердечно-сосудистых заболеваний. Рекомендуют физическую активность, отказ от курения, при необходимости — лечение."},
    {"q": "Триглицериды повышены причины", "a": "Повышение триглицеридов бывает при избытке углеводов и жиров в питании, диабете, гипотиреозе, приёме алкоголя. Интерпретация с врачом."},
    {"q": "АЛТ повышена что это значит", "a": "Повышение АЛТ указывает на повреждение печени: гепатиты, жировая болезнь, приём гепатотоксичных препаратов. Оценивается вместе с АСТ и другими показателями."},
    {"q": "АСТ повышена причины", "a": "АСТ повышается при поражении печени, сердца (инфаркт), мышц. Соотношение АСТ/АЛТ помогает уточнить источник. Расшифровка — у врача."},
    {"q": "Билирубин общий повышен что значит", "a": "Повышенный билирубин бывает при гемолизе, заболеваниях печени и желчевыводящих путей, синдроме Жильбера. Важна фракция — прямая/непрямая."},
    {"q": "Билирубин прямой повышен", "a": "Повышение прямого билирубина характерно для холестаза, гепатитов, обструкции желчных путей. Требуется УЗИ и консультация гастроэнтеролога."},
    {"q": "Креатинин повышен в крови причины", "a": "Высокий креатинин бывает при снижении функции почек, обезвоживании, приёме нефротоксичных препаратов. Оценивают вместе с СКФ и мочевиной."},
    {"q": "Мочевина повышена что это", "a": "Повышенная мочевина возможна при почечной недостаточности, обезвоживании, избытке белка в питании, кровотечении в ЖКТ. Интерпретирует врач."},
    {"q": "Мочевая кислота повышена причины", "a": "Высокая мочевая кислота бывает при подагре, почечной недостаточности, ожирении, диете с избытком пуринов. Рекомендации даёт терапевт или ревматолог."},
    {"q": "Общий белок понижен причины", "a": "Низкий белок возможен при недостаточном питании, заболеваниях печени, почек, кишечника, ожогах. Нужно дообследование."},
    {"q": "Альбумин понижен что значит", "a": "Снижение альбумина бывает при болезнях печени, почек, нарушении всасывания, воспалении. Оценивается в комплексе с другими анализами."},
    # Щитовидная железа
    {"q": "ТТГ повышен что это значит", "a": "Повышенный ТТГ часто указывает на гипотиреоз (снижение функции щитовидной железы) или компенсацию при приёме тироксина. Нужны Т4 свободный и консультация эндокринолога."},
    {"q": "ТТГ понижен причины", "a": "Низкий ТТГ бывает при тиреотоксикозе, передозировке тироксина, патологии гипофиза. Оценивается вместе с Т3 и Т4 свободными."},
    {"q": "Норма ТТГ у женщин", "a": "Референс ТТГ у взрослых обычно около 0,4–4,0 мМЕ/л (зависит от лаборатории). При беременности нормы другие. Уточняйте на бланке."},
    {"q": "Т4 свободный повышен что делать", "a": "Повышение свободного Т4 может указывать на тиреотоксикоз. Нужны ТТГ, Т3 и осмотр эндокринолога для решения о лечении."},
    {"q": "Т4 свободный понижен", "a": "Низкий свободный Т4 при высоком ТТГ характерен для гипотиреоза. Лечение назначает эндокринолог (заместительная терапия)."},
    {"q": "Т3 свободный повышен", "a": "Повышенный Т3 свободный бывает при тиреотоксикозе. Интерпретация вместе с ТТГ и Т4, лечение — у эндокринолога."},
    # Женские гормоны
    {"q": "Эстрадиол понижен у женщин причины", "a": "Низкий эстрадиол возможен при менопаузе, нарушении цикла, истощении яичников, гипофизарной недостаточности. Расшифровка — у гинеколога или эндокринолога."},
    {"q": "Эстрадиол повышен что значит", "a": "Повышение эстрадиола бывает при фолликулярных кистах, опухолях, ожирении, приёме препаратов. Оценка в контексте фазы цикла и клиники."},
    {"q": "Прогестерон понижен при беременности", "a": "Низкий прогестерон при беременности требует наблюдения врача — возможна недостаточность жёлтого тела. Не ставьте диагноз сами, обратитесь к гинекологу."},
    {"q": "Прогестерон повышен причины", "a": "Высокий прогестерон бывает во вторую фазу цикла, при беременности, кистах жёлтого тела, патологии надпочечников. Интерпретация по дню цикла."},
    {"q": "ФСГ повышен у женщин что значит", "a": "Повышенный ФСГ у женщин возможен при снижении резерва яичников, менопаузе, после удаления яичников. Оценивается вместе с ЛГ и эстрадиолом."},
    {"q": "ФСГ понижен у женщин", "a": "Низкий ФСГ бывает при гипофизарной недостаточности, стрессовой аменорее, приёме гормонов. Расшифровка — у гинеколога-эндокринолога."},
    {"q": "ЛГ повышен у женщин причины", "a": "Повышение ЛГ характерно для овуляторного пика, СПКЯ, снижения резерва яичников, менопаузы. Соотношение ЛГ/ФСГ важно для диагноза."},
    {"q": "Пролактин повышен у женщин причины", "a": "Высокий пролактин бывает при аденоме гипофиза, гипотиреозе, приёме препаратов, стрессе. При значительном повышении — МРТ и эндокринолог."},
    {"q": "Пролактин понижен", "a": "Низкий пролактин встречается реже, возможен при недостаточности гипофиза. Обычно оценивается при бесплодии и нарушении цикла."},
    {"q": "Тестостерон у женщин повышен причины", "a": "Повышение тестостерона у женщин бывает при СПКЯ, патологии надпочечников, опухолях. Проявления: гирсутизм, акне, нарушение цикла. Лечение — у гинеколога."},
    {"q": "АМГ понижен что это значит", "a": "Низкий АМГ указывает на снижение овариального резерва (меньше фолликулов). Важно для планирования беременности. Обсудите с репродуктологом."},
    {"q": "АМГ повышен у женщин", "a": "Повышенный АМГ бывает при СПКЯ. Интерпретация вместе с УЗИ и другими гормонами. Консультация гинеколога."},
    {"q": "ДГЭА сульфат повышен у женщин", "a": "Высокий ДГЭА у женщин возможен при гиперандрогении надпочечникового генеза, опухолях. Нужна оценка других андрогенов и врач."},
    # Мужские гормоны
    {"q": "Тестостерон понижен у мужчин причины", "a": "Низкий тестостерон у мужчин бывает при возрастном дефиците, патологии яичек/гипофиза, ожирении, хронических болезнях. Диагноз и лечение — у уролога-андролога."},
    {"q": "Тестостерон общий норма у мужчин", "a": "Норма общего тестостерона у мужчин примерно 12–35 нмоль/л (референсы зависят от лаборатории и возраста). На бланке указаны границы."},
    {"q": "ПСА повышен что делать", "a": "Повышение ПСА бывает при аденоме простаты, простатите, после манипуляций, при раке простаты. Обязательна консультация уролога и дообследование."},
    {"q": "ПСА норма по возрасту мужчин", "a": "Референсы ПСА зависят от возраста (обычно до 4 нг/мл для 40–50 лет, выше — для пожилых). Важна динамика и свободный/общий ПСА. Уточняйте у уролога."},
    {"q": "ФСГ повышен у мужчин", "a": "Повышенный ФСГ у мужчин возможен при первичной недостаточности яичек, после химиотерапии. Оценивается вместе с ЛГ и тестостероном. Андролог."},
    {"q": "ЛГ повышен у мужчин", "a": "Высокий ЛГ у мужчин бывает при первичном гипогонадизме. Интерпретация с ФСГ и тестостероном. Консультация уролога-андролога."},
    # Беременность
    {"q": "ХГЧ понижен при беременности", "a": "Низкий ХГЧ может указывать на внематочную беременность, замершую беременность или неверный срок. Контроль в динамике и УЗИ — по назначению врача."},
    {"q": "ХГЧ повышен что значит", "a": "Высокий ХГЧ бывает при многоплодной беременности, пузырном заносе, некоторых опухолях. Оценка по сроку и УЗИ. Гинеколог."},
    {"q": "Прогестерон при беременности норма", "a": "Нормы прогестерона при беременности зависят от срока (растут по триместрам). Референсы указывает лаборатория. Расшифровка — у акушера-гинеколога."},
    # Витамины и железо
    {"q": "Витамин D понижен что делать", "a": "Низкий витамин D корригируют солнцем, питанием и препаратами (дозу подбирает врач). Длительный дефицит влияет на кости и иммунитет."},
    {"q": "Витамин B12 понижен причины", "a": "Снижение B12 бывает при веганской диете без дополнения, нарушении всасывания (ЖКТ), пернициозной анемии. Лечение — у терапевта/гастроэнтеролога."},
    {"q": "Ферритин понижен что это значит", "a": "Низкий ферритин указывает на истощение запасов железа (часто до снижения гемоглобина). Причина и лечение — у врача."},
    {"q": "Ферритин повышен причины", "a": "Повышенный ферритин бывает при гемохроматозе, воспалении, заболеваниях печени, избытке железа. Интерпретация с ОЖСС и клиникой."},
    {"q": "Железо в крови понижено", "a": "Низкое железо характерно для железодефицитной анемии и хронических кровопотерь. Оценивают с ферритином и трансферрином. Лечение назначает врач."},
    {"q": "Фолиевая кислота понижена", "a": "Дефицит фолиевой кислоты бывает при недостатке в питании, нарушении всасывания, приёме некоторых препаратов. Важно при планировании беременности. Врач подберёт дозу."},
    # Моча
    {"q": "Белок в моче повышен причины", "a": "Белок в моче бывает при заболеваниях почек, инфекциях мочевых путей, гипертонии, диабете. Суточная протеинурия и консультация нефролога/терапевта."},
    {"q": "Лейкоциты в моче повышены что значит", "a": "Повышение лейкоцитов в моче указывает на воспаление: цистит, пиелонефрит, уретрит. Нужен посев и лечение у врача."},
    {"q": "Эритроциты в моче повышены причины", "a": "Эритроциты в моче бывают при камнях, инфекциях, гломерулонефритах, опухолях. Важно количество и вид (свежие/выщелоченные). Уролог или нефролог."},
    {"q": "Бактерии в моче что значит", "a": "Бактерии в моче в большом количестве — признак инфекции мочевых путей. Посев с определением чувствительности и лечение по назначению врача."},
    # Коагулограмма
    {"q": "МНО повышен что это", "a": "Повышенное МНО означает снижение свёртываемости (риск кровотечения). У принимающих варфарин — коррекция дозы по назначению врача."},
    {"q": "Фибриноген повышен причины", "a": "Высокий фибриноген бывает при воспалении, беременности, инфаркте, инсульте. Оценивается в комплексе с другими показателями свёртывания."},
    {"q": "Д-димер повышен что значит", "a": "Повышение D-димера возможно при тромбозах, ДВС, беременности, воспалении. Не специфичен — интерпретация с клиникой и другими анализами."},
    # Воспаление и онкомаркеры
    {"q": "СРБ повышен что это значит", "a": "С-реактивный белок повышается при воспалении, инфекциях, инфаркте. Высокочувствительный СРБ используют для оценки риска сердечно-сосудистых событий."},
    {"q": "РЭА онкомаркер повышен", "a": "Повышение РЭА бывает при опухолях ЖКТ, курении, воспалении. Не используется для первичной диагностики — только в динамике и в комплексе. Онколог."},
    {"q": "СА-125 повышен что значит", "a": "СА-125 повышается при раке яичников, эндометриозе, воспалении, кистах. Не специфичен — расшифровка с УЗИ и гинекологом."},
    {"q": "ПСА свободный и общий соотношение", "a": "Соотношение свободный/общий ПСА помогает дифференцировать рак простаты и доброкачественные процессы. Низкое соотношение — больше поводов для дообследования. Уролог."},
    # Дополнительно: общий анализ крови (индексы, формула)
    {"q": "MCV понижен что это", "a": "Сниженный MCV (средний объём эритроцита) характерен для железодефицитной анемии, талассемии. Оценивается с гемоглобином и ферритином. Врач."},
    {"q": "MCV повышен причины", "a": "Повышение MCV бывает при дефиците B12 и фолиевой кислоты, алкоголизме, гипотиреозе. Интерпретация с другими показателями крови."},
    {"q": "MCH понижен что значит", "a": "Низкий MCH (среднее содержание гемоглобина в эритроците) часто при железодефицитной анемии. Расшифровка у терапевта или гематолога."},
    {"q": "Лимфоциты повышены у взрослого", "a": "Повышение лимфоцитов бывает при вирусных инфекциях, хроническом лимфолейкозе, некоторых бактериальных инфекциях. Оценка по лейкоцитарной формуле."},
    {"q": "Лимфоциты понижены причины", "a": "Низкие лимфоциты возможны при стрессе, приёме глюкокортикоидов, иммунодефицитах. Интерпретация с клиникой."},
    {"q": "Нейтрофилы повышены что это", "a": "Повышенные нейтрофилы характерны для бактериальных инфекций, воспаления, стресса, после операций. Оценивается вместе с лейкоцитами."},
    {"q": "Нейтрофилы понижены причины", "a": "Снижение нейтрофилов бывает при вирусных инфекциях, приёме лекарств, апластической анемии. При выраженной нейтропении — гематолог."},
    {"q": "Эозинофилы повышены что значит", "a": "Высокие эозинофилы возможны при аллергии, паразитах, некоторых опухолях, астме. Нужна клиника и дообследование."},
    {"q": "Моноциты повышены у взрослого", "a": "Повышение моноцитов бывает при хронических инфекциях, восстановлении после острой инфекции, некоторых опухолях. Интерпретация у врача."},
    {"q": "Базофилы повышены причины", "a": "Повышенные базофилы встречаются редко: аллергии, миелопролиферативные заболевания. Оценка в комплексе с другими показателями."},
    {"q": "RDW повышен что это", "a": "Высокий RDW (разброс объёма эритроцитов) указывает на неоднородность эритроцитов, часто при железодефиците или после кровопотери. Врач интерпретирует с MCV."},
    # Биохимия расширенная
    {"q": "ГГТП повышена причины", "a": "Повышение ГГТП бывает при заболеваниях печени и желчных путей, приёме алкоголя, приёме некоторых препаратов. Оценивается с АЛТ, АСТ."},
    {"q": "Щелочная фосфатаза повышена что значит", "a": "Высокая щелочная фосфатаза возможна при патологии печени и желчных путей, костной ткани, при беременности. Нужна фракция и клиника."},
    {"q": "Калий повышен в крови причины", "a": "Гиперкалиемия бывает при почечной недостаточности, приёме калийсберегающих диуретиков, надпочечниковой недостаточности. Требует контроля врача."},
    {"q": "Калий понижен что делать", "a": "Низкий калий возможен при потере с рвотой/диареей, приёме диуретиков, гиперальдостеронизме. Коррекция по назначению врача."},
    {"q": "Натрий понижен в крови", "a": "Гипонатриемия бывает при избытке жидкости, сердечной недостаточности, циррозе, приёме диуретиков. Интерпретация у терапевта или нефролога."},
    {"q": "Кальций общий повышен причины", "a": "Повышение кальция возможно при гиперпаратиреозе, опухолях, избытке витамина D, обездвиженности. Нужны ионизированный кальций и ПТГ."},
    {"q": "Кальций понижен что это", "a": "Низкий кальций бывает при гипопаратиреозе, дефиците витамина D, почечной недостаточности. Лечение назначает врач."},
    {"q": "Магний понижен в крови", "a": "Дефицит магния возможен при диарее, приёме диуретиков, алкоголизме, диабете. Коррекция по рекомендации врача."},
    {"q": "Фосфор повышен причины", "a": "Высокий фосфор бывает при почечной недостаточности, гипопаратиреозе, избытке витамина D. Оценка вместе с кальцием."},
    {"q": "ЛДГ повышен что это значит", "a": "Повышение ЛДГ неспецифично: повреждение печени, сердца, мышц, эритроцитов, опухоли. Нужна фракция ЛДГ и клиника."},
    {"q": "КФК повышена причины", "a": "Высокая КФК бывает при повреждении мышц (инфаркт миокарда, миозит, травма), после физической нагрузки. КФК-МБ — маркер сердца."},
    {"q": "Амилаза повышена что значит", "a": "Повышение амилазы характерно для острого панкреатита, патологии слюнных желез, почечной недостаточности. Интерпретация с липазой."},
    {"q": "Липаза повышена причины", "a": "Высокая липаза — более специфичный признак острого панкреатита. Оценка вместе с амилазой и клиникой. Гастроэнтеролог или хирург."},
    {"q": "Сывороточное железо повышено", "a": "Повышенное железо сыворотки бывает при гемохроматозе, гемолитической анемии, приёме препаратов железа. Оценивают с ферритином и ОЖСС."},
    {"q": "ОЖСС повышена что это", "a": "Повышенная ОЖСС часто при железодефиците. Оценка вместе с сывороточным железом и ферритином. Терапевт."},
    {"q": "Трансферрин понижен причины", "a": "Низкий трансферрин бывает при воспалении, заболеваниях печени, нефротическом синдроме. Интерпретация с железом и ферритином."},
    # Щитовидная железа доп.
    {"q": "Антитела к ТПО повышены что значит", "a": "Высокие антитела к ТПО указывают на аутоиммунный тиреоидит (Хашимото). Оцениваются с ТТГ и Т4. Эндокринолог."},
    {"q": "Антитела к ТГ повышены", "a": "Повышение антител к тиреоглобулину бывает при аутоиммунном тиреоидите, раке щитовидной железы. Интерпретация с ТТГ и УЗИ."},
    {"q": "Т3 общий понижен", "a": "Низкий Т3 общий возможен при гипотиреозе, тяжёлых заболеваниях (низкий T3-синдром). Оценка с ТТГ и Т4 свободным."},
    # Женские гормоны доп.
    {"q": "Пролактин при планировании беременности", "a": "Высокий пролактин может нарушать овуляцию. При повышении — исключить аденому гипофиза, при необходимости лечение. Гинеколог или эндокринолог."},
    {"q": "Эстрадиол на 3 день цикла норма", "a": "На 3-й день цикла эстрадиол обычно низкий (фолликулярная фаза). Референсы зависят от лаборатории. Расшифровка у гинеколога."},
    {"q": "Прогестерон на 21 день цикла", "a": "На 21-й день при 28-дневном цикле прогестерон отражает функцию жёлтого тела. Низкий уровень — возможна недостаточность лютеиновой фазы. Гинеколог."},
    {"q": "Ингибин B понижен у женщин", "a": "Низкий ингибин B указывает на снижение овариального резерва. Важно для планирования беременности. Репродуктолог."},
    {"q": "Кортизол повышен причины у женщин", "a": "Высокий кортизол бывает при стрессе, синдроме Кушинга, аденоме надпочечников. Оценка суточного ритма и дексаметазоновой пробы. Эндокринолог."},
    {"q": "Кортизол понижен что это", "a": "Низкий кортизол возможен при надпочечниковой недостаточности. Требуется дообследование и лечение у эндокринолога."},
    # Мужские гормоны доп.
    {"q": "ГСПГ понижен у мужчин", "a": "Низкий ГСПГ бывает при ожирении, гипотиреозе, андрогенах. Оценка свободного тестостерона. Уролог-андролог."},
    {"q": "Эстрадиол у мужчин повышен", "a": "Повышение эстрадиола у мужчин возможно при ожирении, опухолях, циррозе. Интерпретация с тестостероном. Андролог."},
    {"q": "Пролактин повышен у мужчин причины", "a": "Высокий пролактин у мужчин снижает либидо и может вызывать гинекомастию. Исключают аденому гипофиза. Эндокринолог."},
    # Беременность доп.
    {"q": "ХГЧ на ранних сроках норма", "a": "Нормы ХГЧ по неделям беременности указаны в таблицах лабораторий. Важна динамика роста. Расшифровка у гинеколога."},
    {"q": "PAPP-A понижен при беременности", "a": "Низкий PAPP-A может ассоциироваться с риском хромосомных аномалий и осложнений. Оценка в рамках скрининга 1 триместра. Генетик, гинеколог."},
    {"q": "Свободный бета-ХГЧ повышен", "a": "Повышение свободного бета-ХГЧ в скрининге оценивается вместе с PAPP-A и УЗИ. Возможен пересчёт рисков. Консультация генетика."},
    # Витамины и микроэлементы доп.
    {"q": "Витамин D норма в крови", "a": "Оптимальный уровень 25-OH витамина D обычно 30–60 нг/мл. Дефицит — ниже 20. Референсы уточняйте в лаборатории."},
    {"q": "Витамин B12 норма", "a": "Референс B12 зависит от лаборатории (часто 200–900 пг/мл). Дефицит требует подтверждения и выяснения причины. Врач."},
    {"q": "Гомоцистеин повышен что делать", "a": "Высокий гомоцистеин — фактор риска тромбозов и сердечно-сосудистых заболеваний. Коррекция фолиевой кислотой и B12 по назначению врача."},
    {"q": "Цинк понижен в крови", "a": "Дефицит цинка возможен при нарушении всасывания, вегетарианской диете. Оценка с клиникой. Врач порекомендует коррекцию."},
    {"q": "Селен в крови понижен", "a": "Низкий селен встречается при недостатке в питании. Значение для щитовидной железы и иммунитета. Коррекция по рекомендации врача."},
    # Моча доп.
    {"q": "Кетоны в моче что значит", "a": "Кетоны в моче бывают при голодании, диабете (кетоз), лихорадке. При диабете — срочный контроль глюкозы и врача."},
    {"q": "Глюкоза в моче при беременности", "a": "Глюкоза в моче при беременности может быть при гестационном диабете или снижении почечного порога. Контроль глюкозы крови и гинеколог."},
    {"q": "Уробилиноген в моче повышен", "a": "Повышение уробилиногена возможно при гемолизе, заболеваниях печени. Оценка с билирубином крови. Врач."},
    {"q": "Плоский эпителий в моче повышен", "a": "Большое количество плоского эпителия часто говорит о неправильном заборе (попадание из половых путей). При необходимости — повторный анализ."},
    {"q": "Соли в моче оксалаты", "a": "Оксалаты в моче бывают при питании с избытком щавелевой кислоты, риске камнеобразования. Рекомендации по питанию — уролог или нефролог."},
    # Коагулограмма доп.
    {"q": "АЧТВ повышен что это", "a": "Удлинение АЧТВ указывает на снижение свёртываемости: дефицит факторов, антикоагулянты, антифосфолипидный синдром. Интерпретация у врача."},
    {"q": "Протромбин по Квику понижен", "a": "Низкий протромбин бывает при приёме варфарина, заболеваниях печени, дефиците витамина K. Коррекция по назначению врача."},
    # Сердце и маркеры
    {"q": "Тропонин повышен что значит", "a": "Повышение тропонина — маркер повреждения миокарда (инфаркт, миокардит). При болях в груди — срочно к врачу или скорая."},
    {"q": "Креатинкиназа МБ повышена", "a": "КФК-МБ повышается при инфаркте миокарда, миокардите. Оценка с тропонином и ЭКГ. Кардиолог или скорая."},
    {"q": "NT-proBNP повышен причины", "a": "Высокий NT-proBNP указывает на сердечную недостаточность или перегрузку сердца. Интерпретация с ЭхоКГ. Кардиолог."},
    # Онкомаркеры доп.
    {"q": "СА 19-9 повышен что значит", "a": "СА 19-9 повышается при опухолях поджелудочной железы, желчных путей, реже ЖКТ. Не для скрининга — динамика и дообследование. Онколог."},
    {"q": "СА 15-3 онкомаркер повышен", "a": "СА 15-3 может повышаться при раке молочной железы, доброкачественных процессах. Оценка в динамике и с другими методами. Онколог."},
    {"q": "АФП повышен что это", "a": "Повышение АФП бывает при раке печени, опухолях половых клеток, при беременности (норма). Интерпретация с клиникой и УЗИ."},
    {"q": "ХГЧ у мужчин повышен", "a": "Повышенный ХГЧ у небеременных и у мужчин может указывать на опухоль (например, герминогенная). Обследование у уролога/онколога."},
    # Инфекции и иммунитет
    {"q": "Антитела к цитомегаловирусу IgG положительный", "a": "IgG к ЦМВ говорит о прошлой встрече с вирусом. Для риска при беременности важен авидность и IgM. Гинеколог или инфекционист."},
    {"q": "Антитела к вирусу Эпштейна-Барр", "a": "Разные антитела (IgM, IgG к капсиду и ядерному антигену) помогают отличить острую инфекцию от перенесённой. Расшифровка у инфекциониста."},
    {"q": "СРБ высокочувствительный повышен", "a": "Высокий вчСРБ — маркер риска сердечно-сосудистых событий. Оценка вместе с липидами и клиникой. Терапевт или кардиолог."},
    # Общие вопросы
    {"q": "Как подготовиться к анализу крови", "a": "Обычно сдают натощак (8–12 ч без еды), исключают алкоголь и сильные нагрузки за сутки. Конкретные требования уточняйте в лаборатории и у врача."},
    {"q": "Почему анализ крови из вены", "a": "Венозная кровь даёт стабильные результаты по биохимии и гормонам. Капиллярная кровь допустима для части анализов (глюкоза, ОАК в некоторых системах)."},
    {"q": "Референсные значения что это", "a": "Референсы — диапазон нормы, указанный лабораторией для пола и возраста. Выход за границы не всегда болезнь — интерпретирует врач."},
    {"q": "Можно ли пить воду перед анализом крови", "a": "Обычно чистую воду пить можно. Кофе, чай, сок — нежелательны. Уточняйте в лаборатории для конкретного анализа."},
]

# Вариации формулировок пользователя (~5000 вопросов): «почему у меня», «как понять» и т.д.
QUESTION_PREFIXES = [
    "Почему у меня ", "Как понять что ", "У меня ", "Что делать если ", "Подскажите про ", "Почему ",
    "Как быть если ", "От чего ", "Из-за чего ", "Подскажите ", "Скажите ", "Объясните ", "Расскажите про ",
    "У меня в анализе ", "В анализе ", "Вопрос: ", "Интересует ", "Не могу разобраться: ", "Помогите разобраться: ",
    "Как понять: ", "Что значит если ", "Чем грозит ", "Опасно ли что ", "Нормально ли что ", "Правильно ли что ",
    "Почему может быть ", "Из-за чего может быть ", "Бывает ли что ", "Может ли быть что ",
    "Подскажите пожалуйста ", "Расшифруйте пожалуйста ", "Помогите с расшифровкой: ", "В бланке написано что ",
    "Результат показал что ", "Обнаружили что ", "Нашли что ", "Выявлено что ", "Показало что ",
    "Анализ выявил ", "В результатах ", "По анализу ", "По результатам ", "Расшифровка: ", "Вопрос по анализу: ",
    "Вопрос по показателю: ", "Интересно почему ", "Хочу понять ", "Нужно ли волноваться если ", "Стоит ли переживать если ",
    "Насколько серьезно что ", "К чему может привести что ", "Чем опасно что ", "Что делать когда ",
    "Куда обращаться если ", "К какому врачу если ", "Как лечить если ", "Как привести в норму ",
    "Как интерпретировать ", "Как читать результат ", "Что означает ", "Расшифруйте ", "Разъясните ", "Поясните ",
    "Не понимаю результат: ", "Запутался в анализах: ", "Первый раз сдал: ", "Получил результат: ", "Пришел анализ: ",
    "Высокий как понять ", "Низкий как понять ", "Повышенный как понять ", "Пониженный как понять ",
    # Ещё вариации для разнообразия ответов (тот же смысл — другой тон)
    "Почему же у меня ", "Объясните почему ", "Скажите почему ", "Хотел бы узнать почему ", "Интересует почему ",
    "Что делать при ", "Как действовать при ", "Как поступить при ", "Куда идти если ", "К кому обратиться если ",
    "Чем опасен ", "Чем грозит повышенный ", "Чем грозит пониженный ", "Опасен ли ", "Серьёзно ли что ",
    "Можно ли не лечить если ", "Нужно ли лечение если ", "Требуется ли лечение при ", "Обязательно ли к врачу при ",
    "Как часто пересдавать при ", "Когда пересдать ", "Через сколько пересдать ", "Нужен ли повторный анализ при ",
    "Влияет ли на здоровье ", "Влияет ли на беременность ", "Влияет ли на детей ", "Беременность и ",
    "Ребёнок сдал: ", "У ребёнка ", "У мужа ", "У жены ", "У мамы ", "У папы ", "Родственник: ",
    "После болезни ", "После операции ", "На фоне приёма лекарств ", "Принимаю препараты: ",
    "Страшно ли что ", "Паниковать ли если ", "Переживаю из-за ", "Беспокоит результат: ",
    "В норме ли ", "Нормально ли значение ", "Правильный ли показатель ", "Корректный ли результат ",
    "Отклонение от нормы: ", "Выходит за референс ", "Ниже нормы ", "Выше нормы ", "За границей нормы ",
    "Расшифруйте показатель: ", "Разъясните значение: ", "Что означает цифра: ", "Как трактовать: ",
    "Терапевт сказал пересдать: ", "Врач направил на анализ: ", "По направлению врача: ",
    "Планирую беременность: ", "Готовлюсь к операции: ", "На диспансеризации обнаружили: ",
    # Доп. формулировки для охвата 250+ вариантов вопросов и 20k+ ответов
    "Почему так получилось ", "Откуда берётся ", "Из-за чего бывает ", "Причины того что ", "Почему бывает ",
    "Что значит когда ", "Как расценивать ", "Как смотреть на ", "Как воспринимать ", "Как оценить ",
    "Нужна ли диета при ", "Питание при ", "Можно ли спортом при ", "Ограничения при ", "Образ жизни при ",
    "Совместимо ли с беременностью ", "При беременности нашли ", "Беременность: ", "Кормление грудью и ",
    "У подростка ", "У пожилого ", "Возраст и ", "Пол и показатель: ", "Женщина/мужчина: ",
    "После ковида ", "После инфекции ", "После антибиотиков ", "На фоне стресса ", "При усталости ",
    "Связь с другими показателями ", "В комплексе с ", "Вместе с ", "Параллельно с ",
    "Ложноположительный ли ", "Ошибка лаборатории? ", "Могли перепутать? ", "Точность анализа при ",
    "Как поднять ", "Как снизить ", "Как скорректировать ", "Как нормализовать ", "Лечение при ",
    "Препараты при ", "Витамины при ", "БАДы при ", "Добавки при ", "Народные методы при ",
    "Срочно ли к врачу при ", "Скорая ли при ", "Планово или срочно при ", "Когда записаться при ",
    "Какой врач при ", "Терапевт или узкий при ", "Нужен ли узкий специалист при ",
    "Повторный анализ когда ", "Контроль через ", "Динамика при ", "Тренд показателя: ",
    "Вариант нормы ли ", "Индивидуальная норма ", "Референс и мой результат: ", "Чуть выше/ниже нормы: ",
    "Критично ли ", "Умеренно ", "Значительно ", "Сильно отклонён: ", "Небольшое отклонение: ",
    "Расшифровка для чайников: ", "Простыми словами: ", "По-человечески: ", "Без медицинского: ",
]

# Вариации тона и обёртки ответов (~250+ вариантов на базу → 20k+ уникальных ответов)
def _answer_wrappers():
    prefixes = [
        "", "По этому показателю: ", "Кратко: ", "Суть: ", "В расшифровке: ", "По результату: ",
        "С учётом показателя: ", "В контексте анализа: ", "Интерпретация: ", "Важно: ",
        "Обычно это значит: ", "Чаще всего: ", "Как правило: ", "В большинстве случаев: ",
        "С медицинской точки зрения: ", "С точки зрения лаборатории: ", "Для ориентира: ",
        "В двух словах: ", "Если коротко: ", "По смыслу анализа: ", "Расшифровка: ", "Итог: ",
        "Практический вывод: ", "С клинической точки зрения: ", "Что это может значить: ",
    ]
    suffixes = [
        "", " Рекомендуем обсудить с врачом.", " Обратитесь к специалисту для интерпретации.",
        " Не стоит паниковать — точную интерпретацию даст врач.", " Конкретные рекомендации даст лечащий врач.",
        " Уточнить диагноз и тактику поможет врач.", " Окончательную расшифровку проводит врач.",
        " Важно оценить в комплексе с другими анализами и клиникой.", " Интерпретацию в вашей ситуации даст врач.",
        " За подробностями — к врачу, назначившему анализ.", " Дальнейшие шаги определит врач.",
        " При сомнениях — повторный анализ и консультация врача.", " Не заменяет консультацию врача.",
        " Это общая информация; решение по лечению принимает врач.", " Уточните у врача, назначившего анализ.",
        " Точную трактовку даст лечащий врач.", " Рекомендуем показать результаты врачу.",
        " В каждом случае решение принимает врач.", " Обсудите с врачом при очном приёме.",
        " Не откладывайте визит к врачу при сомнениях.", " Следующий шаг — консультация специалиста.",
    ]
    out = []
    for p in prefixes:
        for s in suffixes:
            out.append((p, s))
    # Дополнительные вариации тона
    extra = [
        ("Не волнуйтесь заранее. ", " Обратитесь к врачу для уточнения."),
        ("Кратко: ", " Подробности — у врача."),
        ("", " Это не диагноз — интерпретирует врач."),
        ("По показателю: ", " Рекомендуем консультацию специалиста."),
        ("Важно понимать: ", " Итоговое заключение даёт врач."),
        ("", " За детальной расшифровкой — к врачу."),
        ("С учётом клиники: ", " Итог подведёт врач."),
        ("Общая информация: ", " Персональные рекомендации даст врач."),
    ] * 8
    out.extend(extra)
    return out

_ANSWER_WRAPPER_LIST = _answer_wrappers()


def _expand_faq():
    """Генерация ~5000 вариантов вопросов и 20k+ вариантов ответов из базы FAQ."""
    out = []
    for item in FAQ:
        q_base, a_base = item["q"], item["a"]
        # Вопросы: базовая формулировка + варианты с префиксами пользователя
        questions = [q_base]
        for prefix in QUESTION_PREFIXES:
            questions.append(prefix + q_base)
        # Ответы: 250+ обёрток (префикс + базовый ответ + суффикс)
        answers = []
        for i, (p, s) in enumerate(_ANSWER_WRAPPER_LIST):
            a = (p + a_base + s).strip()
            if a and a != a_base:
                answers.append(a)
            else:
                answers.append(a_base)
        if not answers:
            answers = [a_base]
        # Пары (вопрос, ответ): каждый вариант вопроса + один из вариантов ответа (по тону)
        n_q, n_a = len(questions), len(answers)
        for j, q in enumerate(questions):
            a = answers[j % n_a]
            out.append({"q": q, "a": a})
        # Классические синонимы формулировок (повышен/высокий, понижен/низкий, норма/нормы)
        if "повышен" in q_base or "повышены" in q_base:
            q_alt = q_base.replace("повышен", "высокий").replace("повышены", "высокие")
            for j, q in enumerate([q_alt] + [p + q_alt for p in QUESTION_PREFIXES[:20]]):
                out.append({"q": q, "a": answers[j % n_a]})
        if "понижен" in q_base or "понижены" in q_base:
            q_alt = q_base.replace("понижен", "низкий").replace("понижены", "низкие")
            for j, q in enumerate([q_alt] + [p + q_alt for p in QUESTION_PREFIXES[:20]]):
                out.append({"q": q, "a": answers[j % n_a]})
        if "норма" in q_base:
            q_alt = q_base.replace("норма", "нормы").replace("у женщин", "для женщин").replace("у мужчин", "для мужчин")
            for j, q in enumerate([q_alt] + [p + q_alt for p in QUESTION_PREFIXES[:20]]):
                out.append({"q": q, "a": answers[j % n_a]})
    return out

FAQ_LIST = _expand_faq()


# Однобуквенные/короткие обозначения, которые оставляем в токенах (витамины D, B, K и т.п.)
# Латинские и русские однобуквенные обозначения витаминов (D/д, B, K/к)
ALLOW_SINGLE_CHAR = {"d", "b", "k", "д", "к"}

# Синонимы и аббревиатуры: запрос и вопрос сопоставляются по смыслу (не только по первым словам)
SYNONYMS = {
    "ттг": {"ттг", "тиреотропный", "тиротропин"},
    "т3": {"т3", "трийодтиронин"},
    "т4": {"т4", "тироксин"},
    "гемоглобин": {"гемоглобин", "hb"},
    "эритроциты": {"эритроциты", "rbc"},
    "лейкоциты": {"лейкоциты", "wbc"},
    "тромбоциты": {"тромбоциты", "plt"},
    "соэ": {"соэ", "скорость", "осад"},
    "глюкоза": {"глюкоза", "сахар", "гликемия"},
    "холестерин": {"холестерин", "холестерол"},
    "алт": {"алт", "алат", "аланинаминотрансфераза"},
    "аст": {"аст", "асат", "аспартатаминотрансфераза"},
    "билирубин": {"билирубин"},
    "креатинин": {"креатинин"},
    "мочевина": {"мочевина"},
    "мочевая": {"мочевая", "урикемия"},
    "ферритин": {"ферритин"},
    "железо": {"железо", "сывороточное"},
    "пса": {"пса", "простата", "простат"},
    "тестостерон": {"тестостерон"},
    "пролактин": {"пролактин"},
    "прогестерон": {"прогестерон"},
    "эстрадиол": {"эстрадиол"},
    "хгч": {"хгч", "хорионический"},
    "фсг": {"фсг", "фолликулостимулирующий"},
    "лг": {"лг", "лютеинизирующий"},
    "амг": {"амг", "антимюллеров"},
    "витамин": {"витамин"},
    "срб": {"срб", "реактивный", "c-reactive"},
    "тропонин": {"тропонин"},
    "ддимер": {"ддимер", "димер", "d-димер"},
    "мно": {"мно", "inr"},
    "фибриноген": {"фибриноген"},
    "высокий": {"высокий", "повышен", "повышены", "повышенный", "высокие"},
    "низкий": {"низкий", "понижен", "понижены", "пониженный", "низкие"},
    "норма": {"норма", "нормы", "норму", "референс"},
    # Короткие обозначения витаминов: латиница и русские аббревиатуры (витамин д = витамин D)
    "d": {"d", "витамин", "д"},
    "д": {"д", "d", "витамин"},
    "b": {"b", "витамин", "в"},
    "b12": {"b12", "в12", "витамин", "цианокобаламин"},
    "в12": {"в12", "b12", "витамин", "цианокобаламин"},
    "k": {"k", "витамин", "к"},
    "к": {"к", "k", "витамин"},
}


def _preprocess_query(query: str) -> str:
    """Раскрываем короткие обозначения: «низкий D», «витамин д» -> витамин D; русские аббревиатуры д/к = D/K."""
    q = query.strip().lower()
    # Русские аббревиатуры: витамин(а) д/к = витамин D/K
    q = re.sub(r"витамин[а]?\s+д\b", "витамин d", q)
    q = re.sub(r"витамин[а]?\s+к\b", "витамин k", q)
    # Отдельно стоящие буквы — витамины (латинское d не трогаем, если уже «витамин d»)
    q = re.sub(r"\bд\b", "витамин d", q)  # кириллица «д»
    q = re.sub(r"(?<!витамин\s)\bd\b", "витамин d", q, flags=re.IGNORECASE)
    q = re.sub(r"\bb\s*12\b", "витамин b12", q, flags=re.IGNORECASE)
    q = re.sub(r"\bв\s*12\b", "витамин в12", q, flags=re.IGNORECASE)
    q = re.sub(r"(?<!витамин\s)\bk\b", "витамин k", q, flags=re.IGNORECASE)
    # отдельное «к» (кириллица) не заменяем — частый предлог; «витамин к» уже заменён выше
    return q


def _normalize(text: str, allow_short: bool = False) -> List[str]:
    """Токены для поиска. allow_short: оставлять однобуквенные d, b, k (для витаминов в вопросе FAQ)."""
    text = re.sub(r"[^\w\s]", " ", text.lower())
    words = text.split()
    # Стоп-слова: бытовые формулировки («почему у меня», «как понять») не мешают поиску по смыслу
    stop = {
        "что", "это", "значит", "как", "почему", "какой", "какая", "какие", "причины", "причина",
        "у", "в", "на", "при", "по", "для", "из", "и", "или", "с", "без", "не", "нет", "да", "так", "же", "ли",
        "нужно", "надо", "можно", "делать", "означает", "быть", "есть", "анализ", "анализе", "анализов", "крови", "моче", "мочи",
        "меня", "понять", "узнать", "подскажите", "скажите", "объясните", "расскажите", "пожалуйста",
        "разобраться", "волноваться", "переживать", "расшифровать", "расшифровка", "толкуйте", "поясните", "разъясните",
        "вопрос", "интересует", "помогите", "результат", "результате", "результаты", "анализе", "бланке", "написано", "показало", "выявлено", "обнаружили", "нашли",
    }
    out = []
    for w in words:
        if w in stop:
            continue
        if len(w) == 1:
            if allow_short and w in ALLOW_SINGLE_CHAR:
                out.append(w)
            continue
        out.append(w)
    return out


def _expand_query_tokens(tokens: set) -> set:
    """Расширяем токены запроса синонимами — ищем по смыслу, не только по первым словам."""
    out = set(tokens)
    for t in tokens:
        if t in SYNONYMS:
            out |= SYNONYMS[t]
    return out


# Минимальный порог: без достаточного совпадения ответ не выдаём
MIN_SCORE = 2.5
# Минимум совпадающих токенов в вопросе FAQ (хотя бы один значимый термин из запроса)
MIN_MATCH_IN_QUESTION = 1


def search_faq(query: str, top_k: int = 3) -> List[Tuple[str, str, float]]:
    """
    Улучшенный поиск: препроцессинг запроса (D -> витамин D), синонимы, совпадения по всему вопросу/ответу, порог, дедупликация.
    """
    if not query or not query.strip():
        return []
    # Раскрываем «низкий D», «витамин b12» и т.п. до полного смысла
    query_prep = _preprocess_query(query)
    q_tokens = set(_normalize(query_prep, allow_short=True))
    if not q_tokens:
        return []
    q_tokens_expanded = _expand_query_tokens(q_tokens)
    # Доля совпадающих терминов запроса — поощряем максимальное совпадение по смыслу
    query_terms_count = len(q_tokens_expanded)
    results = []
    for item in FAQ_LIST:
        q_text = item["q"]
        a_text = item["a"]
        q_tok = set(_normalize(q_text, allow_short=True))
        a_tok = set(_normalize(a_text, allow_short=True))
        match_q = q_tokens_expanded & q_tok
        match_a = q_tokens_expanded & a_tok
        if len(match_q) < MIN_MATCH_IN_QUESTION:
            continue
        # Оценка: совпадения в вопросе важнее; бонус за покрытие большей части запроса
        score_q = len(match_q) * 2.5
        score_a = len(match_a) * 0.5
        coverage = (len(match_q) + len(match_a)) / max(1, query_terms_count)
        score = score_q + score_a + coverage * 1.5
        if score < MIN_SCORE:
            continue
        results.append((q_text, a_text, score))
    results.sort(key=lambda x: -x[2])
    by_answer = {}
    for q_text, a_text, score in results:
        key = a_text.strip()[:300]
        if key not in by_answer or by_answer[key][2] < score:
            by_answer[key] = (q_text, a_text, score)
    unique = list(by_answer.values())
    unique.sort(key=lambda x: -x[2])
    return unique[:top_k]
