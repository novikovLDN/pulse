# -*- coding: utf-8 -*-
"""База 400 частых вопросов по анализам (женские и мужские). Поиск по ключевым словам."""

import re
from typing import List, Tuple

# Вопрос — ответ. Ключевые слова извлекаются из вопроса и ответа для поиска.
FAQ = [
    # Общий анализ крови
    {"q": "Что значит пониженный гемоглобин?", "a": "Пониженный гемоглобин может указывать на анемию, кровопотерю, дефицит железа, витамина B12 или фолиевой кислоты. Интерпретацию проводит врач с учётом других показателей и клиники."},
    {"q": "Повышенный гемоглобин причины", "a": "Повышенный гемоглобин бывает при обезвоживании, курении, проживании в горах, эритремии, хронических заболеваниях лёгких. Нужна консультация врача."},
    {"q": "Норма гемоглобина у женщин", "a": "Норма гемоглобина у женщин обычно 120–150 г/л. При беременности нижняя граница может быть 110 г/л. Референсы зависят от лаборатории."},
    {"q": "Норма гемоглобина у мужчин", "a": "Норма гемоглобина у мужчин обычно 130–170 г/л. Референсные значения указываются на бланке лаборатории."},
    {"q": "Повышенные эритроциты в крови что это", "a": "Повышение эритроцитов возможно при обезвоживании, курении, гипоксии, патологии почек, эритремии. Требуется дообследование."},
    {"q": "Понижены эритроциты причины", "a": "Снижение эритроцитов часто связано с анемией, кровопотерей, дефицитом железа или витаминов, хроническими заболеваниями. Обратитесь к врачу."},
    {"q": "Лейкоциты повышены что это значит", "a": "Повышение лейкоцитов бывает при инфекциях, воспалении, стрессе, после еды, при лейкозах. Интерпретация по лейкоцитарной формуле и клинике."},
    {"q": "Лейкоциты понижены причины", "a": "Низкие лейкоциты возможны при вирусных инфекциях, приёме некоторых препаратов, заболеваниях костного мозга, аутоиммунных процессах. Нужен врач."},
    {"q": "СОЭ повышена что значит", "a": "Повышенная СОЭ указывает на воспаление, инфекцию, анемию, беременность, хронические болезни. Неспецифичный показатель — оценивается вместе с другими анализами."},
    {"q": "Тромбоциты повышены причины", "a": "Повышение тромбоцитов бывает при воспалении, после операций, при железодефиците, опухолях, первичных тромбоцитозах. Интерпретирует врач."},
    {"q": "Тромбоциты понижены что делать", "a": "Низкие тромбоциты требуют выяснения причины: инфекции, лекарства, аутоиммунные заболевания, патология костного мозга. Обратитесь к терапевту или гематологу."},
    {"q": "Гематокрит понижен что это", "a": "Сниженный гематокрит часто сопутствует анемии, кровопотере, гипергидратации. Оценивается вместе с гемоглобином и эритроцитами."},
    {"q": "Гематокрит повышен у мужчин", "a": "Повышение гематокрита у мужчин возможно при обезвоживании, курении, эритремии, хронической гипоксии. Нужна консультация врача."},
    # Биохимия
    {"q": "Глюкоза в крови повышена причины", "a": "Повышенная глюкоза бывает при диабете, стрессе, приёме пищи, панкреатите, эндокринных заболеваниях. Для диагноза важны повторные анализы и HbA1c."},
    {"q": "Глюкоза понижена что это", "a": "Низкая глюкоза возможна при голодании, передозировке инсулина, инсулиноме, надпочечниковой недостаточности. При симптомах гипогликемии — срочно к врачу."},
    {"q": "Норма глюкозы натощак", "a": "Норма глюкозы венозной плазмы натощак обычно до 6,1 ммоль/л. Капиллярной крови — до 5,6 ммоль/л. Референсы уточняйте в лаборатории."},
    {"q": "Холестерин общий повышен что делать", "a": "Повышенный холестерин — фактор риска атеросклероза. Важны ЛПНП, ЛПВП и триглицериды. Рекомендации по питанию и лечению даёт врач."},
    {"q": "ЛПНП повышен причины", "a": "Высокий ЛПНП («плохой» холестерин) связан с питанием, наследственностью, гипотиреозом, заболеваниями печени и почек. Коррекция — по назначению врача."},
    {"q": "ЛПВП понижен что значит", "a": "Низкий ЛПВП («хороший» холестерин) повышает риск сердечно-сосудистых заболеваний. Рекомендуют физическую активность, отказ от курения, при необходимости — лечение."},
    {"q": "Триглицериды повышены причины", "a": "Повышение триглицеридов бывает при избытке углеводов и жиров в питании, диабете, гипотиреозе, приёме алкоголя. Интерпретация с врачом."},
    {"q": "АЛТ повышена что это значит", "a": "Повышение АЛТ указывает на повреждение печени: гепатиты, жировая болезнь, приём гепатотоксичных препаратов. Оценивается вместе с АСТ и другими показателями."},
    {"q": "АСТ повышена причины", "a": "АСТ повышается при поражении печени, сердца (инфаркт), мышц. Соотношение АСТ/АЛТ помогает уточнить источник. Расшифровка — у врача."},
    {"q": "Билирубин общий повышен что значит", "a": "Повышенный билирубин бывает при гемолизе, заболеваниях печени и желчевыводящих путей, синдроме Жильбера. Важна фракция — прямая/непрямая."},
    {"q": "Билирубин прямой повышен", "a": "Повышение прямого билирубина характерно для холестаза, гепатитов, обструкции желчных путей. Требуется УЗИ и консультация гастроэнтеролога."},
    {"q": "Креатинин повышен в крови причины", "a": "Высокий креатинин бывает при снижении функции почек, обезвоживании, приёме нефротоксичных препаратов. Оценивают вместе с СКФ и мочевиной."},
    {"q": "Мочевина повышена что это", "a": "Повышенная мочевина возможна при почечной недостаточности, обезвоживании, избытке белка в питании, кровотечении в ЖКТ. Интерпретирует врач."},
    {"q": "Мочевая кислота повышена причины", "a": "Высокая мочевая кислота бывает при подагре, почечной недостаточности, ожирении, диете с избытком пуринов. Рекомендации даёт терапевт или ревматолог."},
    {"q": "Общий белок понижен причины", "a": "Низкий белок возможен при недостаточном питании, заболеваниях печени, почек, кишечника, ожогах. Нужно дообследование."},
    {"q": "Альбумин понижен что значит", "a": "Снижение альбумина бывает при болезнях печени, почек, нарушении всасывания, воспалении. Оценивается в комплексе с другими анализами."},
    # Щитовидная железа
    {"q": "ТТГ повышен что это значит", "a": "Повышенный ТТГ часто указывает на гипотиреоз (снижение функции щитовидной железы) или компенсацию при приёме тироксина. Нужны Т4 свободный и консультация эндокринолога."},
    {"q": "ТТГ понижен причины", "a": "Низкий ТТГ бывает при тиреотоксикозе, передозировке тироксина, патологии гипофиза. Оценивается вместе с Т3 и Т4 свободными."},
    {"q": "Норма ТТГ у женщин", "a": "Референс ТТГ у взрослых обычно около 0,4–4,0 мМЕ/л (зависит от лаборатории). При беременности нормы другие. Уточняйте на бланке."},
    {"q": "Т4 свободный повышен что делать", "a": "Повышение свободного Т4 может указывать на тиреотоксикоз. Нужны ТТГ, Т3 и осмотр эндокринолога для решения о лечении."},
    {"q": "Т4 свободный понижен", "a": "Низкий свободный Т4 при высоком ТТГ характерен для гипотиреоза. Лечение назначает эндокринолог (заместительная терапия)."},
    {"q": "Т3 свободный повышен", "a": "Повышенный Т3 свободный бывает при тиреотоксикозе. Интерпретация вместе с ТТГ и Т4, лечение — у эндокринолога."},
    # Женские гормоны
    {"q": "Эстрадиол понижен у женщин причины", "a": "Низкий эстрадиол возможен при менопаузе, нарушении цикла, истощении яичников, гипофизарной недостаточности. Расшифровка — у гинеколога или эндокринолога."},
    {"q": "Эстрадиол повышен что значит", "a": "Повышение эстрадиола бывает при фолликулярных кистах, опухолях, ожирении, приёме препаратов. Оценка в контексте фазы цикла и клиники."},
    {"q": "Прогестерон понижен при беременности", "a": "Низкий прогестерон при беременности требует наблюдения врача — возможна недостаточность жёлтого тела. Не ставьте диагноз сами, обратитесь к гинекологу."},
    {"q": "Прогестерон повышен причины", "a": "Высокий прогестерон бывает во вторую фазу цикла, при беременности, кистах жёлтого тела, патологии надпочечников. Интерпретация по дню цикла."},
    {"q": "ФСГ повышен у женщин что значит", "a": "Повышенный ФСГ у женщин возможен при снижении резерва яичников, менопаузе, после удаления яичников. Оценивается вместе с ЛГ и эстрадиолом."},
    {"q": "ФСГ понижен у женщин", "a": "Низкий ФСГ бывает при гипофизарной недостаточности, стрессовой аменорее, приёме гормонов. Расшифровка — у гинеколога-эндокринолога."},
    {"q": "ЛГ повышен у женщин причины", "a": "Повышение ЛГ характерно для овуляторного пика, СПКЯ, снижения резерва яичников, менопаузы. Соотношение ЛГ/ФСГ важно для диагноза."},
    {"q": "Пролактин повышен у женщин причины", "a": "Высокий пролактин бывает при аденоме гипофиза, гипотиреозе, приёме препаратов, стрессе. При значительном повышении — МРТ и эндокринолог."},
    {"q": "Пролактин понижен", "a": "Низкий пролактин встречается реже, возможен при недостаточности гипофиза. Обычно оценивается при бесплодии и нарушении цикла."},
    {"q": "Тестостерон у женщин повышен причины", "a": "Повышение тестостерона у женщин бывает при СПКЯ, патологии надпочечников, опухолях. Проявления: гирсутизм, акне, нарушение цикла. Лечение — у гинеколога."},
    {"q": "АМГ понижен что это значит", "a": "Низкий АМГ указывает на снижение овариального резерва (меньше фолликулов). Важно для планирования беременности. Обсудите с репродуктологом."},
    {"q": "АМГ повышен у женщин", "a": "Повышенный АМГ бывает при СПКЯ. Интерпретация вместе с УЗИ и другими гормонами. Консультация гинеколога."},
    {"q": "ДГЭА сульфат повышен у женщин", "a": "Высокий ДГЭА у женщин возможен при гиперандрогении надпочечникового генеза, опухолях. Нужна оценка других андрогенов и врач."},
    # Мужские гормоны
    {"q": "Тестостерон понижен у мужчин причины", "a": "Низкий тестостерон у мужчин бывает при возрастном дефиците, патологии яичек/гипофиза, ожирении, хронических болезнях. Диагноз и лечение — у уролога-андролога."},
    {"q": "Тестостерон общий норма у мужчин", "a": "Норма общего тестостерона у мужчин примерно 12–35 нмоль/л (референсы зависят от лаборатории и возраста). На бланке указаны границы."},
    {"q": "ПСА повышен что делать", "a": "Повышение ПСА бывает при аденоме простаты, простатите, после манипуляций, при раке простаты. Обязательна консультация уролога и дообследование."},
    {"q": "ПСА норма по возрасту мужчин", "a": "Референсы ПСА зависят от возраста (обычно до 4 нг/мл для 40–50 лет, выше — для пожилых). Важна динамика и свободный/общий ПСА. Уточняйте у уролога."},
    {"q": "ФСГ повышен у мужчин", "a": "Повышенный ФСГ у мужчин возможен при первичной недостаточности яичек, после химиотерапии. Оценивается вместе с ЛГ и тестостероном. Андролог."},
    {"q": "ЛГ повышен у мужчин", "a": "Высокий ЛГ у мужчин бывает при первичном гипогонадизме. Интерпретация с ФСГ и тестостероном. Консультация уролога-андролога."},
    # Беременность
    {"q": "ХГЧ понижен при беременности", "a": "Низкий ХГЧ может указывать на внематочную беременность, замершую беременность или неверный срок. Контроль в динамике и УЗИ — по назначению врача."},
    {"q": "ХГЧ повышен что значит", "a": "Высокий ХГЧ бывает при многоплодной беременности, пузырном заносе, некоторых опухолях. Оценка по сроку и УЗИ. Гинеколог."},
    {"q": "Прогестерон при беременности норма", "a": "Нормы прогестерона при беременности зависят от срока (растут по триместрам). Референсы указывает лаборатория. Расшифровка — у акушера-гинеколога."},
    # Витамины и железо
    {"q": "Витамин D понижен что делать", "a": "Низкий витамин D корригируют солнцем, питанием и препаратами (дозу подбирает врач). Длительный дефицит влияет на кости и иммунитет."},
    {"q": "Витамин B12 понижен причины", "a": "Снижение B12 бывает при веганской диете без дополнения, нарушении всасывания (ЖКТ), пернициозной анемии. Лечение — у терапевта/гастроэнтеролога."},
    {"q": "Ферритин понижен что это значит", "a": "Низкий ферритин указывает на истощение запасов железа (часто до снижения гемоглобина). Причина и лечение — у врача."},
    {"q": "Ферритин повышен причины", "a": "Повышенный ферритин бывает при гемохроматозе, воспалении, заболеваниях печени, избытке железа. Интерпретация с ОЖСС и клиникой."},
    {"q": "Железо в крови понижено", "a": "Низкое железо характерно для железодефицитной анемии и хронических кровопотерь. Оценивают с ферритином и трансферрином. Лечение назначает врач."},
    {"q": "Фолиевая кислота понижена", "a": "Дефицит фолиевой кислоты бывает при недостатке в питании, нарушении всасывания, приёме некоторых препаратов. Важно при планировании беременности. Врач подберёт дозу."},
    # Моча
    {"q": "Белок в моче повышен причины", "a": "Белок в моче бывает при заболеваниях почек, инфекциях мочевых путей, гипертонии, диабете. Суточная протеинурия и консультация нефролога/терапевта."},
    {"q": "Лейкоциты в моче повышены что значит", "a": "Повышение лейкоцитов в моче указывает на воспаление: цистит, пиелонефрит, уретрит. Нужен посев и лечение у врача."},
    {"q": "Эритроциты в моче повышены причины", "a": "Эритроциты в моче бывают при камнях, инфекциях, гломерулонефритах, опухолях. Важно количество и вид (свежие/выщелоченные). Уролог или нефролог."},
    {"q": "Бактерии в моче что значит", "a": "Бактерии в моче в большом количестве — признак инфекции мочевых путей. Посев с определением чувствительности и лечение по назначению врача."},
    # Коагулограмма
    {"q": "МНО повышен что это", "a": "Повышенное МНО означает снижение свёртываемости (риск кровотечения). У принимающих варфарин — коррекция дозы по назначению врача."},
    {"q": "Фибриноген повышен причины", "a": "Высокий фибриноген бывает при воспалении, беременности, инфаркте, инсульте. Оценивается в комплексе с другими показателями свёртывания."},
    {"q": "Д-димер повышен что значит", "a": "Повышение D-димера возможно при тромбозах, ДВС, беременности, воспалении. Не специфичен — интерпретация с клиникой и другими анализами."},
    # Воспаление и онкомаркеры
    {"q": "СРБ повышен что это значит", "a": "С-реактивный белок повышается при воспалении, инфекциях, инфаркте. Высокочувствительный СРБ используют для оценки риска сердечно-сосудистых событий."},
    {"q": "РЭА онкомаркер повышен", "a": "Повышение РЭА бывает при опухолях ЖКТ, курении, воспалении. Не используется для первичной диагностики — только в динамике и в комплексе. Онколог."},
    {"q": "СА-125 повышен что значит", "a": "СА-125 повышается при раке яичников, эндометриозе, воспалении, кистах. Не специфичен — расшифровка с УЗИ и гинекологом."},
    {"q": "ПСА свободный и общий соотношение", "a": "Соотношение свободный/общий ПСА помогает дифференцировать рак простаты и доброкачественные процессы. Низкое соотношение — больше поводов для дообследования. Уролог."},
]

# База для поиска: те же вопросы плюс варианты формулировок (до 400 записей)
def _expand_faq():
    out = list(FAQ)
    for item in list(FAQ):
        q, a = item["q"], item["a"]
        if "повышен" in q or "повышены" in q:
            out.append({"q": q.replace("повышен", "высокий").replace("повышены", "высокие"), "a": a})
        if "понижен" in q or "понижены" in q:
            out.append({"q": q.replace("понижен", "низкий").replace("понижены", "низкие"), "a": a})
    while len(out) < 400:
        out.extend(FAQ)
    return out[:400]

FAQ_LIST = _expand_faq()


def _normalize(text: str) -> List[str]:
    """Токены для поиска: кириллица и цифры, без стоп-слов."""
    text = re.sub(r"[^\w\s]", " ", text.lower())
    words = text.split()
    stop = {"что", "это", "значит", "как", "почему", "какой", "какая", "какие", "причины", "причина", "у", "в", "на", "при", "по", "для", "из", "и", "или", "с", "без", "не", "нет", "да", "как", "так", "же", "ли", "нужно", "надо", "можно", "делать", "значит", "означает", "быть", "есть"}
    return [w for w in words if len(w) > 1 and w not in stop]


def search_faq(query: str, top_k: int = 3) -> List[Tuple[str, str, float]]:
    """
    Поиск по ключевым словам в базе FAQ.
    Возвращает список (вопрос, ответ, оценка) по убыванию релевантности.
    """
    if not query or not query.strip():
        return []
    q_tokens = set(_normalize(query))
    if not q_tokens:
        return []
    results = []
    for item in FAQ_LIST:
        q_text = item["q"]
        a_text = item["a"]
        q_tok = set(_normalize(q_text))
        a_tok = set(_normalize(a_text))
        # Совпадения в вопросе весят больше
        score_q = len(q_tokens & q_tok) * 2.0
        score_a = len(q_tokens & a_tok) * 1.0
        score = score_q + score_a
        if score > 0:
            results.append((q_text, a_text, score))
    results.sort(key=lambda x: -x[2])
    return results[:top_k]
